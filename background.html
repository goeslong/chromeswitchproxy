<html>
<head>
<script type=""text/css">
var should_show_popup = false;
function hasConnection() {
  var plugin = document.getElementById("proxy_plugin");
  return plugin.connectionName != "__No connection__";
}
function updateUI() {  
  var plugin = document.getElementById("proxy_plugin");
  plugin = document.getElementById("proxy_plugin");
  var icon_path = "proxy_off.png";
  var name = plugin.connectionName;
  var title;
  if (!hasConnection()) {
    title = chrome.i18n.getMessage("noConnection");
	icon_path = "no_connection.png";
  } else {
    var config = plugin.getProxyConfig(); 
    var proxy_state = chrome.i18n.getMessage("noProxy");
    if (config.useProxy) {
      icon_path = "proxy_on.png";
      proxy_state = chrome.i18n.getMessage("proxyIs") + config.proxyServer;
	  if (should_show_popup) {
	    proxy_state += chrome.i18n.getMessage("inPlaceEditPrompt");
		chrome.browserAction.setPopup({popup: "popup.html"});
		icon_path = "proxy_can_edit.png";
	  }
    }
	title = plugin.connectionName + " " + proxy_state;
  }
  chrome.browserAction.setIcon({path: icon_path});
  chrome.browserAction.setTitle({title: title});
}

function disablePopup () {
  chrome.browserAction.setPopup({popup: ""});
  should_show_popup = false;
  updateUI();
}

chrome.browserAction.onClicked.addListener(function(tab) {
  if (hasConnection()) {
    var plugin = document.getElementById("proxy_plugin");
    var config = plugin.getProxyConfig();
    var use_proxy = !config.useProxy;
    plugin.setProxyConfig(use_proxy);    
  }
  should_show_popup = use_proxy;
  updateUI();
  if (should_show_popup) {
    // Automatically close editing after 10 seconds.
    setTimeout("disablePopup();", 100000);
  }  
}); 

chrome.tabs.onCreated.addListener(function(tab) {  
  updateUI();
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
  updateUI();
});

function loadProxyList() {
  var str = localStorage["proxyList"];
  if (!str || str == "") {
    return [];
  }
  var proxyList = JSON.parse(str);  
  return proxyList;
}

function storeProxyList(proxyList) {
  var str = JSON.stringify(proxyList);
  localStorage["proxyList"] = str;
}

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    if (request.message == "refresh") {
      disablePopup();
    } else if (request.message == 'loadproxylist') {
      var proxyList = loadProxyList();
      sendResponse({list: proxyList});
    } else if (request.message == 'storeproxylist') {
      storeProxyList(request.data);
    }    
  });

  </script>
</head>
<body>
<embed id="proxy_plugin" type="application/x-switch-wininet-proxy" hidden="true">
</body>
</html>
